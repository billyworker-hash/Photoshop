#!/usr/bin/env node
/*! For license information please see app.js.LICENSE.txt */
(()=>{var e={3:module=>{"use strict";module.exports=require("path")},37:module=>{"use strict";module.exports=require("mongoose")},252:module=>{"use strict";module.exports=require("express")},269:(module,e,t)=>{var n=t(37),s=new n.Schema({name:String,email:{type:String,unique:!0},passwordHash:String,role:{type:String,enum:["admin","agent"],default:"agent"},status:{type:String,enum:["active","inactive"],default:"active"},hourlyRate:{type:Number,default:0},createdAt:{type:Date,default:Date.now}}),a=new n.Schema({name:{type:String,required:!0,unique:!0},label:{type:String,required:!0},type:{type:String,enum:["text","number","email","phone","select","textarea"],default:"text"},options:[String],required:{type:Boolean,default:!1},order:{type:Number,default:0},isActive:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now}}),r=new n.Schema({name:{type:String,required:!0},description:{type:String,default:""},labels:[{name:String,label:String,type:{type:String,enum:["text","number","email","phone","select","textarea"],default:"text"},options:[String],required:{type:Boolean,default:!1}}],createdBy:{type:n.Schema.Types.ObjectId,ref:"User"},isSystem:{type:Boolean,default:!1},isActive:{type:Boolean,default:!0},isCustomerList:{type:Boolean,default:!1},isVisibleToUsers:{type:Boolean,default:!0},visibleToSpecificAgents:[{type:n.Schema.Types.ObjectId,ref:"User"}],isVisible:{type:Boolean,default:!0},createdAt:{type:Date,default:Date.now}});r.pre("save",(function(e){if(!this.isSystem&&!this.createdBy)return e(new Error("createdBy is required for non-system lists"));e()}));var o=new n.Schema({status:{type:String,enum:["new","No Answer","Voice Mail","Call Back Qualified","Call Back NOT Qualified","deposited","active","withdrawn","inactive"],default:"new"},assignedTo:{type:n.Schema.Types.ObjectId,ref:"User"},customFields:{type:Map,of:n.Schema.Types.Mixed},leadList:{type:n.Schema.Types.ObjectId,ref:"LeadList"},notes:[{content:String,createdAt:{type:Date,default:Date.now},createdBy:{type:n.Schema.Types.ObjectId,ref:"User"}}],createdAt:{type:Date,default:Date.now}}),i=new n.Schema({fullName:String,email:String,phone:String,country:String,language:String,status:{type:String,enum:["new","No Answer","Voice Mail","Call Back Qualified","Call Back NOT Qualified","deposited","active","withdrawn","inactive"],default:"new"},customFields:{type:Map,of:n.Schema.Types.Mixed},agent:{type:n.Schema.Types.ObjectId,ref:"User",required:!0},originalLead:{type:n.Schema.Types.ObjectId,ref:"Lead"},originalLeadList:{type:n.Schema.Types.ObjectId,ref:"LeadList"},originalListName:String,originalListLabels:[{name:String,label:String,type:{type:String,enum:["text","number","email","phone","select","textarea"],default:"text"},options:[String],required:{type:Boolean,default:!1}}],notes:[{content:String,createdAt:{type:Date,default:Date.now},createdBy:{type:n.Schema.Types.ObjectId,ref:"User"}}],createdAt:{type:Date,default:Date.now}}),u=new n.Schema({fullName:String,email:String,phone:String,country:String,language:String,status:{type:String,enum:["new","No Answer","Voice Mail","Call Back Qualified","Call Back NOT Qualified","deposited","active","withdrawn","inactive"],default:"deposited"},customFields:{type:Map,of:n.Schema.Types.Mixed},agent:{type:n.Schema.Types.ObjectId,ref:"User",required:!0},originalCustomer:{type:n.Schema.Types.ObjectId,ref:"Customer"},originalLead:{type:n.Schema.Types.ObjectId,ref:"Lead"},originalLeadList:{type:n.Schema.Types.ObjectId,ref:"LeadList"},originalListName:String,originalListLabels:[{name:String,label:String,type:{type:String,enum:["text","number","email","phone","select","textarea"],default:"text"},options:[String],required:{type:Boolean,default:!1}}],notes:[{content:String,createdAt:{type:Date,default:Date.now},createdBy:{type:n.Schema.Types.ObjectId,ref:"User"}}],createdAt:{type:Date,default:Date.now}}),c=new n.Schema({agent:{type:n.Schema.Types.ObjectId,ref:"User",required:!0},date:{type:Date,required:!0},clockIn:{type:Date},clockOut:{type:Date},totalHours:{type:Number,default:0},hourlyRate:{type:Number,default:0},totalPay:{type:Number,default:0},status:{type:String,enum:["clocked-in","clocked-out","manual"],default:"clocked-out"},isManualEntry:{type:Boolean,default:!1},notes:{type:String,default:""},createdBy:{type:n.Schema.Types.ObjectId,ref:"User"},createdAt:{type:Date,default:Date.now},updatedAt:{type:Date,default:Date.now}});c.pre("save",(function(e){if(this.clockIn&&this.clockOut){var t=(this.clockOut-this.clockIn)/36e5;this.totalHours=Math.round(100*t)/100,this.totalPay=Math.round(this.totalHours*this.hourlyRate*100)/100}this.updatedAt=new Date,e()}));var l=n.model("User",s),d=n.model("Lead",o),p=n.model("LeadField",a),m=n.model("LeadList",r),f=n.model("Customer",i),g=n.model("Depositor",u),y=n.model("TimeEntry",c);module.exports={User:l,Lead:d,LeadField:p,LeadList:m,Customer:f,Depositor:g,TimeEntry:y}},577:module=>{"use strict";module.exports=require("cors")},729:module=>{"use strict";module.exports=require("bcryptjs")},818:module=>{"use strict";module.exports=require("dotenv")},829:module=>{"use strict";module.exports=require("jsonwebtoken")}},t={};function n(s){var a=t[s];if(void 0!==a)return a.exports;var module=t[s]={exports:{}};return e[s](module,module.exports,n),module.exports}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}var a=["customFields"],r=["customFields"];function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){u(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function u(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=s(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=s(a))return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==s(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return l(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,s=Array(t);n<t;n++)s[n]=e[n];return s}function d(e,t){if(null==e)return{};var n,s,a=function(e,t){if(null==e)return{};var n={};for(var s in e)if({}.hasOwnProperty.call(e,s)){if(-1!==t.indexOf(s))continue;n[s]=e[s]}return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(s=0;s<r.length;s++)n=r[s],-1===t.indexOf(n)&&{}.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}function p(){var e,t,n="function"==typeof Symbol?Symbol:{},s=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,s,a,r){var u=s&&s.prototype instanceof i?s:i,c=Object.create(u.prototype);return m(c,"_invoke",function(n,s,a){var r,i,u,c=0,l=a||[],d=!1,p={p:0,n:0,v:e,a:m,f:m.bind(e,4),d:function(t,n){return r=t,i=0,u=e,p.n=n,o}};function m(n,s){for(i=n,u=s,t=0;!d&&c&&!a&&t<l.length;t++){var a,r=l[t],m=p.p,f=r[2];n>3?(a=f===s)&&(u=r[(i=r[4])?5:(i=3,3)],r[4]=r[5]=e):r[0]<=m&&((a=n<2&&m<r[1])?(i=0,p.v=s,p.n=r[1]):m<f&&(a=n<3||r[0]>s||s>f)&&(r[4]=n,r[5]=s,p.n=f,i=0))}if(a||n>1)return o;throw d=!0,s}return function(a,l,f){if(c>1)throw TypeError("Generator is already running");for(d&&1===l&&m(l,f),i=l,u=f;(t=i<2?e:u)||!d;){r||(i?i<3?(i>1&&(p.n=-1),m(i,u)):p.n=u:p.v=u);try{if(c=2,r){if(i||(a="next"),t=r[a]){if(!(t=t.call(r,u)))throw TypeError("iterator result is not an object");if(!t.done)return t;u=t.value,i<2&&(i=0)}else 1===i&&(t=r.return)&&t.call(r),i<2&&(u=TypeError("The iterator does not provide a '"+a+"' method"),i=1);r=e}else if((t=(d=p.n<0)?u:n.call(s,p))!==o)break}catch(t){r=e,i=1,u=t}finally{c=1}}return{value:t,done:d}}}(n,a,r),!0),c}var o={};function i(){}function u(){}function c(){}t=Object.getPrototypeOf;var l=[][s]?t(t([][s]())):(m(t={},s,(function(){return this})),t),d=c.prototype=i.prototype=Object.create(l);function f(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,c):(e.__proto__=c,m(e,a,"GeneratorFunction")),e.prototype=Object.create(d),e}return u.prototype=c,m(d,"constructor",c),m(c,"constructor",u),u.displayName="GeneratorFunction",m(c,a,"GeneratorFunction"),m(d),m(d,a,"Generator"),m(d,s,(function(){return this})),m(d,"toString",(function(){return"[object Generator]"})),(p=function(){return{w:r,m:f}})()}function m(e,t,n,s){var a=Object.defineProperty;try{a({},"",{})}catch(e){a=0}m=function(e,t,n,s){if(t)a?a(e,t,{value:n,enumerable:!s,configurable:!s,writable:!s}):e[t]=n;else{var r=function(t,n){m(e,t,(function(e){return this._invoke(t,n,e)}))};r("next",0),r("throw",1),r("return",2)}},m(e,t,n,s)}function f(e,t,n,s,a,r,o){try{var i=e[r](o),u=i.value}catch(e){return void n(e)}i.done?t(u):Promise.resolve(u).then(s,a)}function g(e){return function(){var t=this,n=arguments;return new Promise((function(s,a){var r=e.apply(t,n);function o(e){f(r,s,a,o,i,"next",e)}function i(e){f(r,s,a,o,i,"throw",e)}o(void 0)}))}}var y=n(252),v=n(37),b=n(818),h=n(577),w=n(829),j=n(729),k=n(3),L=n(269),F=L.User,A=L.Lead,S=L.LeadField,B=L.LeadList,O=L.Customer,D=L.Depositor,I=L.TimeEntry;b.config();var T=y();function q(){return E.apply(this,arguments)}function E(){return(E=g(p().m((function e(){var t,n;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,B.findOne({name:"Users with no list"});case 1:if(t=e.v){e.n=3;break}return t=new B({name:"Users with no list",description:"Default list for users whose original lead list has been deleted",labels:[{name:"fullName",label:"Full Name",type:"text"},{name:"email",label:"Email",type:"email"},{name:"phone",label:"Phone",type:"text"},{name:"company",label:"Company",type:"text"}],isSystem:!0,isVisible:!0}),e.n=2,t.save();case 2:console.log('Created "Users with no list" system list');case 3:return e.a(2,t);case 4:return e.p=4,n=e.v,console.error("Error ensuring Users with no list:",n),e.a(2,null)}}),e,null,[[0,4]])})))).apply(this,arguments)}function U(e,t,n){var s=e.headers.authorization,a=null==s?void 0:s.split(" ")[1];if(!a)return t.status(401).json({message:"Access token is required"});try{var r=w.verify(a,process.env.JWT_SECRET);e.user=r,n()}catch(e){return t.status(401).json({message:"Invalid or expired token"})}}function _(e){return function(t,n,s){if(t.user.role!==e)return n.status(403).json({message:"".concat(e," access required")});s()}}T.use(h()),T.use(y.json({limit:"50mb"})),T.use(y.static(k.join(__dirname,"public"))),v.connect(process.env.MONGODB_URI).then((function(){return console.log("MongoDB connected successfully")})).catch((function(e){console.error("MongoDB connection error:",e),process.exit(1)})),T.post("/api/register",function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s=t.body,a=s.name,r=s.email,o=s.password,i=s.role,a&&r&&o){e.n=1;break}return e.a(2,n.status(400).json({message:"Name, email, and password are required"}));case 1:return e.n=2,F.findOne({email:r});case 2:if(!e.v){e.n=3;break}return e.a(2,n.status(400).json({message:"User with this email already exists"}));case 3:return e.n=4,j.hash(o,10);case 4:return u=e.v,c=new F({name:a,email:r,passwordHash:u,role:i||"agent",status:"active"}),e.n=5,c.save();case 5:n.status(201).json({message:"User created successfully",user:{id:c._id,name:c.name,email:c.email,role:c.role}}),e.n=7;break;case 6:e.p=6,l=e.v,console.error("Registration error:",l),n.status(500).json({message:"Internal server error"});case 7:return e.a(2)}}),e,null,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/login",function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s=t.body,a=s.email,r=s.password,a&&r){e.n=1;break}return e.a(2,n.status(400).json({message:"Email and password are required"}));case 1:return e.n=2,F.findOne({email:a,status:"active"});case 2:if(o=e.v){e.n=3;break}return e.a(2,n.status(401).json({message:"Invalid email or password"}));case 3:return e.n=4,j.compare(r,o.passwordHash);case 4:if(e.v){e.n=5;break}return e.a(2,n.status(401).json({message:"Invalid email or password"}));case 5:i=w.sign({id:o._id,role:o.role,name:o.name},process.env.JWT_SECRET,{expiresIn:"24h"}),n.json({token:i,user:{id:o._id,name:o.name,email:o.email,role:o.role}}),e.n=7;break;case 6:e.p=6,u=e.v,console.error("Login error:",u),n.status(500).json({message:"Internal server error"});case 7:return e.a(2)}}),e,null,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/leads",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l,d,m,f,g;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s={},!t.query.leadList){e.n=1;break}s.leadList=t.query.leadList,e.n=3;break;case 1:return a={isActive:!0,isCustomerList:{$ne:!0}},"admin"!==t.user.role&&(a.$or=[{isVisibleToUsers:!0},{visibleToSpecificAgents:t.user.id}]),e.n=2,B.find(a).select("_id");case 2:r=e.v,o=r.map((function(e){return e._id})),s.leadList={$in:o};case 3:return t.query.status&&(s.status=t.query.status),t.query.search&&(i=new RegExp(t.query.search,"i"),s.$or=[{fullName:i},{email:i},{phone:i}]),u=parseInt(t.query.page)||1,c=parseInt(t.query.limit)||10,l=(u-1)*c,e.n=4,A.countDocuments(s);case 4:return d=e.v,e.n=5,A.find(s).populate("assignedTo","name").populate("notes.createdBy","name").sort({createdAt:-1}).skip(l).limit(c);case 5:m=e.v,console.log("[LEADS API] User: ".concat(t.user.username," | Page: ").concat(u," | Limit: ").concat(c," | Total Available: ").concat(d," | Fetched: ").concat(m.length," leads | Filters:"),{leadList:t.query.leadList||"all_active",search:t.query.search||"none",status:t.query.status||"all",source:t.query.leadList?"upload_section":"leads_section"}),f=m.map((function(e){var t=e.toObject();return t.customFields&&(t.customFields=Object.fromEntries(t.customFields)),t})),n.json({leads:f,pagination:{currentPage:u,totalPages:Math.ceil(d/c),totalCount:d,limit:c,hasNext:u<Math.ceil(d/c),hasPrev:u>1}}),e.n=7;break;case 6:e.p=6,g=e.v,console.error("Leads fetch error:",g),n.status(500).json({message:"Failed to fetch leads"});case 7:return e.a(2)}}),e,null,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/leads",U,function(){var e=g(p().m((function e(t,n){var s,r,o,i,u,c;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return s=t.body,r=s.customFields,o=d(s,a),i=new A(o),r&&(i.customFields=new Map(Object.entries(r))),e.n=2,i.save();case 2:(u=i.toObject()).customFields&&(u.customFields=Object.fromEntries(u.customFields)),n.status(201).json(u),e.n=4;break;case 3:e.p=3,c=e.v,console.error("Lead creation error:",c),n.status(500).json({message:"Failed to create lead"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.patch("/api/leads/:id",U,function(){var e=g(p().m((function e(t,n){var s,a,o,i,u,c,l;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s=t.body,a=s.customFields,o=d(s,r),i=o,a&&(i.customFields=new Map(Object.entries(a))),e.n=1,A.findByIdAndUpdate(t.params.id,i,{new:!0});case 1:if(u=e.v){e.n=2;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 2:(c=u.toObject()).customFields&&(c.customFields=Object.fromEntries(c.customFields)),n.json(c),e.n=4;break;case 3:e.p=3,l=e.v,console.error("Lead update error:",l),n.status(500).json({message:"Failed to update lead"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/leads/:id/notes",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s=t.body,a=s.status,r=s.note,e.n=1,A.findById(t.params.id);case 1:if(o=e.v){e.n=2;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 2:return a&&(o.status=a),r&&r.content&&(o.notes||(o.notes=[]),o.notes.push({content:r.content,createdAt:new Date,createdBy:r.createdBy||t.user.id})),e.n=3,o.save();case 3:return e.n=4,o.populate("notes.createdBy","name");case 4:(i=o.toObject()).customFields&&(i.customFields=Object.fromEntries(i.customFields)),n.status(200).json(i),e.n=6;break;case 5:e.p=5,u=e.v,console.error("Error adding note to lead:",u),n.status(500).json({message:"Failed to add note to lead"});case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()),T.delete("/api/leads/:id",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return s=t.params.id,e.n=2,A.findById(s);case 2:if(e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 3:return e.n=4,A.findByIdAndDelete(s);case 4:n.status(200).json({message:"Lead deleted successfully"}),e.n=6;break;case 5:e.p=5,a=e.v,console.error("Error deleting lead:",a),n.status(500).json({message:"Failed to delete lead"});case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/leads/:id/own",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,l,d,m,f,g,y,v,b;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can own leads"}));case 1:return u=t.params.id,e.n=2,A.findById(u).populate("leadList");case 2:if(l=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 3:if(!l.assignedTo){e.n=4;break}return e.a(2,n.status(400).json({message:l.assignedTo.toString()===t.user.id?"You already own this lead":"This lead is already owned by another agent"}));case 4:return d=l.leadList,m=d?d.name:"Unknown List",f=d?d.labels:[],l.assignedTo=t.user.id,l.notes||(l.notes=[]),l.notes.push({content:"Lead claimed",createdAt:new Date,createdBy:t.user.id}),g=new O({fullName:(null===(s=l.customFields)||void 0===s?void 0:s.get("fullName"))||l.fullName||"",email:(null===(a=l.customFields)||void 0===a?void 0:a.get("email"))||l.email||"",phone:(null===(r=l.customFields)||void 0===r?void 0:r.get("phone"))||l.phone||"",country:(null===(o=l.customFields)||void 0===o?void 0:o.get("country"))||l.country||"",language:(null===(i=l.customFields)||void 0===i?void 0:i.get("language"))||l.language||"",status:l.status||"new",customFields:l.customFields||new Map,agent:t.user.id,originalLead:l._id,originalLeadList:d?d._id:null,originalListName:m,originalListLabels:f,notes:c((l.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}})))}),e.n=5,l.save();case 5:return e.n=6,l.populate("notes.createdBy","name");case 6:return e.n=7,g.save();case 7:return e.n=8,g.populate("notes.createdBy","name");case 8:(y=g.toObject()).customFields&&(y.customFields=Object.fromEntries(y.customFields)),(v=l.toObject()).customFields&&(v.customFields=Object.fromEntries(v.customFields)),n.status(200).json({lead:v,customer:y,message:"Lead successfully owned and customer record created"}),e.n=10;break;case 9:e.p=9,b=e.v,console.error("Error owning lead:",b),n.status(500).json({message:"Failed to own lead"});case 10:return e.a(2)}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/leads/:id/release",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can release leads"}));case 1:return s=t.params.id,e.n=2,A.findById(s).populate("assignedTo");case 2:if(a=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 3:if(a.assignedTo){e.n=4;break}return e.a(2,n.status(400).json({message:"This lead is not currently owned"}));case 4:if(a.assignedTo._id.toString()===t.user.id){e.n=5;break}return e.a(2,n.status(403).json({message:"You can only release your own leads"}));case 5:return r=a.assignedTo.name,a.assignedTo=null,a.notes||(a.notes=[]),a.notes.push({content:"Lead released back to general pool by ".concat(r),createdAt:new Date,createdBy:t.user.id}),e.n=6,a.save();case 6:return e.n=7,O.findOne({originalLead:s});case 7:if(!(o=e.v)){e.n=8;break}return o.notes||(o.notes=[]),o.notes.push({content:"Original lead was released back to general pool",createdAt:new Date,createdBy:t.user.id}),e.n=8,o.save();case 8:(i=a.toObject()).customFields&&(i.customFields=Object.fromEntries(i.customFields)),n.status(200).json({lead:i,message:"Lead successfully released back to general pool"}),e.n=10;break;case 9:e.p=9,u=e.v,console.error("Error releasing lead:",u),n.status(500).json({message:"Failed to release lead"});case 10:return e.a(2)}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/leads/:id/take-over",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,l,d,m,f,g,y,v,b,h,w,j,k;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can take over leads"}));case 1:return s=t.params.id,e.n=2,A.findById(s).populate("assignedTo").populate("leadList");case 2:if(a=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 3:if(a.assignedTo){e.n=4;break}return e.a(2,n.status(400).json({message:"This lead is not currently owned by anyone"}));case 4:if(a.assignedTo._id.toString()!==t.user.id){e.n=5;break}return e.a(2,n.status(400).json({message:"You already own this lead"}));case 5:return r=a.assignedTo.name,o=a.assignedTo._id,i=a.leadList,u=i?i.name:"Unknown List",l=i?i.labels:[],a.assignedTo=t.user.id,a.notes||(a.notes=[]),a.notes.push({content:"Lead taken over from ".concat(r),createdAt:new Date,createdBy:t.user.id}),e.n=6,a.save();case 6:return e.n=7,O.findOne({originalLead:s,agent:o});case 7:if(!(d=e.v)){e.n=9;break}return d.agent=t.user.id,d.notes||(d.notes=[]),d.notes.push({content:"Lead taken over from ".concat(r),createdAt:new Date,createdBy:t.user.id}),m=a.notes||[],f=d.notes.length>0?Math.max.apply(Math,c(d.notes.map((function(e){return new Date(e.createdAt).getTime()})))):0,m.forEach((function(e){new Date(e.createdAt).getTime()>f&&d.notes.push({content:e.content,createdAt:e.createdAt,createdBy:e.createdBy})})),e.n=8,d.save();case 8:e.n=10;break;case 9:return w=new O({fullName:(null===(g=a.customFields)||void 0===g?void 0:g.get("fullName"))||a.fullName||"",email:(null===(y=a.customFields)||void 0===y?void 0:y.get("email"))||a.email||"",phone:(null===(v=a.customFields)||void 0===v?void 0:v.get("phone"))||a.phone||"",country:(null===(b=a.customFields)||void 0===b?void 0:b.get("country"))||a.country||"",language:(null===(h=a.customFields)||void 0===h?void 0:h.get("language"))||a.language||"",status:a.status||"new",customFields:a.customFields||new Map,agent:t.user.id,originalLead:a._id,originalLeadList:i?i._id:null,originalListName:u,originalListLabels:l,notes:c((a.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}})))}),e.n=10,w.save();case 10:return e.n=11,a.populate("notes.createdBy","name");case 11:(j=a.toObject()).customFields&&(j.customFields=Object.fromEntries(j.customFields)),n.status(200).json({lead:j,message:"Lead successfully taken over from ".concat(r)}),e.n=13;break;case 12:e.p=12,k=e.v,console.error("Error taking over lead:",k),n.status(500).json({message:"Failed to take over lead"});case 13:return e.a(2)}}),e,null,[[0,12]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/dashboard/stats",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,u,c,l,d,m;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s="agent"===t.user.role?{assignedTo:t.user.id}:{},console.log("[DASHBOARD STATS] User: ".concat(t.user.username," | Role: ").concat(t.user.role," | Using aggregation for efficient dashboard stats")),e.n=1,A.aggregate([{$match:s},{$count:"totalLeads"}]);case 1:return a=e.v,r=a.length>0?a[0].totalLeads:0,e.n=2,A.aggregate([{$match:s},{$group:{_id:"$status",count:{$sum:1}}}]);case 2:return o=e.v,u={new:0,"No Answer":0,"Voice Mail":0,"Call Back Qualified":0,"Call Back NOT Qualified":0},o.forEach((function(e){u.hasOwnProperty(e._id)&&(u[e._id]=e.count)})),c=new Date,(l=new Date).setMonth(c.getMonth()-5),e.n=3,A.aggregate([{$match:i(i({},s),{},{createdAt:{$gte:l}})},{$group:{_id:{year:{$year:"$createdAt"},month:{$month:"$createdAt"}},count:{$sum:1}}},{$sort:{"_id.year":1,"_id.month":1}}]);case 3:d=e.v,console.log("[DASHBOARD STATS] User: ".concat(t.user.username," | Total: ").concat(r," leads | Efficient aggregation used")),n.json({totalLeads:r,statusBreakdown:u,monthlyTrends:d}),e.n=5;break;case 4:e.p=4,m=e.v,console.error("Dashboard stats error:",m),n.status(500).json({message:"Error fetching dashboard statistics"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/users",U,function(){var e=g(p().m((function e(t,n){var s,a,r;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return s=t.query.role?{role:t.query.role}:{},e.n=2,F.find(s).select("-passwordHash");case 2:a=e.v,n.json(a),e.n=4;break;case 3:e.p=3,r=e.v,console.error("Users fetch error:",r),n.status(500).json({message:"Failed to fetch users"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.patch("/api/users/:id",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return e.n=2,F.findByIdAndUpdate(t.params.id,t.body,{new:!0}).select("-passwordHash");case 2:if(s=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"User not found"}));case 3:n.json(s),e.n=5;break;case 4:e.p=4,a=e.v,console.error("User update error:",a),n.status(500).json({message:"Failed to update user"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.put("/api/users/:id",U,function(){var e=g(p().m((function e(t,s){var a,r,o,i,u,c,l,d,m;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,s.status(403).json({message:"Admin access required"}));case 1:if(a=t.body,r=a.name,o=a.email,i=a.password,u=a.role,r&&o){e.n=2;break}return e.a(2,s.status(400).json({message:"Name and email are required"}));case 2:if(c={name:r,email:o,role:u},!i){e.n=4;break}return l=n(729),e.n=3,l.hash(i,10);case 3:c.passwordHash=e.v;case 4:return e.n=5,F.findByIdAndUpdate(t.params.id,c,{new:!0}).select("-passwordHash");case 5:if(d=e.v){e.n=6;break}return e.a(2,s.status(404).json({message:"User not found"}));case 6:s.json(d),e.n=8;break;case 7:e.p=7,m=e.v,console.error("User update error:",m),s.status(500).json({message:"Failed to update user"});case 8:return e.a(2)}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}()),T.delete("/api/users/:id",U,function(){var e=g(p().m((function e(t,n){var s;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:if(t.params.id!==t.user.id){e.n=2;break}return e.a(2,n.status(400).json({message:"Cannot delete your own account"}));case 2:return e.n=3,F.findByIdAndDelete(t.params.id);case 3:if(e.v){e.n=4;break}return e.a(2,n.status(404).json({message:"User not found"}));case 4:n.json({message:"User deleted successfully"}),e.n=6;break;case 5:e.p=5,s=e.v,console.error("User deletion error:",s),n.status(500).json({message:"Failed to delete user"});case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/users/deactivate-all",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return e.n=2,F.updateMany({_id:{$ne:t.user.id},status:"active"},{status:"inactive",updatedAt:new Date});case 2:s=e.v,console.log("Admin ".concat(t.user.email," deactivated ").concat(s.modifiedCount," users")),n.json({message:"Successfully deactivated ".concat(s.modifiedCount," user(s)"),deactivatedCount:s.modifiedCount}),e.n=4;break;case 3:e.p=3,a=e.v,console.error("Bulk user deactivation error:",a),n.status(500).json({message:"Failed to deactivate users"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/lead-fields",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,S.find({isActive:!0}).sort({order:1});case 1:s=e.v,n.json(s),e.n=3;break;case 2:e.p=2,a=e.v,console.error("Lead fields fetch error:",a),n.status(500).json({message:"Failed to fetch lead fields"});case 3:return e.a(2)}}),e,null,[[0,2]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/lead-fields",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l,d;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:if(s=t.body,a=s.name,r=s.label,o=s.type,i=s.options,u=s.required,c=s.order,a&&r){e.n=2;break}return e.a(2,n.status(400).json({message:"Name and label are required"}));case 2:return l=new S({name:a,label:r,type:o||"text",options:i||[],required:u||!1,order:c||0}),e.n=3,l.save();case 3:n.status(201).json(l),e.n=5;break;case 4:e.p=4,d=e.v,console.error("Lead field creation error:",d),11e3===d.code?n.status(400).json({message:"Field name already exists"}):n.status(500).json({message:"Failed to create lead field"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.put("/api/lead-fields/:id",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return e.n=2,S.findByIdAndUpdate(t.params.id,t.body,{new:!0});case 2:if(s=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Field not found"}));case 3:n.json(s),e.n=5;break;case 4:e.p=4,a=e.v,console.error("Lead field update error:",a),n.status(500).json({message:"Failed to update lead field"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.delete("/api/lead-fields/:id",U,function(){var e=g(p().m((function e(t,n){var s;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return e.n=2,S.findByIdAndUpdate(t.params.id,{isActive:!1},{new:!0});case 2:if(e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Field not found"}));case 3:n.json({message:"Field deleted successfully"}),e.n=5;break;case 4:e.p=4,s=e.v,console.error("Lead field deletion error:",s),n.status(500).json({message:"Failed to delete lead field"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/lead-lists",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s={isActive:!0},void 0!==t.query.isCustomerList&&(s.isCustomerList="true"===t.query.isCustomerList),"admin"!==t.user.role&&(s.$or=[{isVisibleToUsers:!0},{visibleToSpecificAgents:t.user.id}]),e.n=1,B.find(s).populate("createdBy","name email").populate("visibleToSpecificAgents","name email").sort({createdAt:-1});case 1:return a=e.v,console.log("[LEAD-LISTS API] User: ".concat(t.user.username," (").concat(t.user.role,") | Found ").concat(a.length," lists | Using aggregation for efficient counting...")),e.n=2,A.aggregate([{$group:{_id:"$leadList",count:{$sum:1}}}]);case 2:r=e.v,o=new Map,r.forEach((function(e){e._id&&o.set(e._id.toString(),e.count)})),i=a.map((function(e){var t=e.toObject();return t.leadCount=o.get(e._id.toString())||0,t})),console.log("[LEAD-LISTS API] User: ".concat(t.user.username," | Optimized: 1 aggregation query instead of ").concat(a.length," separate queries")),n.json(i),e.n=4;break;case 3:e.p=3,u=e.v,console.error("Lead lists fetch error:",u),n.status(500).json({message:"Failed to fetch lead lists"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/lead-lists",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:if(s=t.body,a=s.name,r=s.description,o=s.labels,i=s.isVisibleToUsers,u=s.visibleToSpecificAgents,a){e.n=2;break}return e.a(2,n.status(400).json({message:"List name is required"}));case 2:return c=new B({name:a,description:r||"",labels:o||[],isVisibleToUsers:void 0===i||i,visibleToSpecificAgents:u||[],createdBy:t.user.id}),e.n=3,c.save();case 3:return e.n=4,c.populate("createdBy","name email");case 4:n.status(201).json(c),e.n=6;break;case 5:e.p=5,l=e.v,console.error("Lead list creation error:",l),n.status(500).json({message:"Failed to create lead list"});case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/lead-lists/:id",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,B.findById(t.params.id).populate("createdBy","name email").populate("visibleToSpecificAgents","name email");case 1:if((s=e.v)&&s.isActive){e.n=2;break}return e.a(2,n.status(404).json({message:"Lead list not found"}));case 2:n.json(s),e.n=4;break;case 3:e.p=3,a=e.v,console.error("Lead list fetch error:",a),n.status(500).json({message:"Failed to fetch lead list"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.put("/api/lead-lists/:id",U,function(){var e=g(p().m((function e(t,n){var s,a;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return e.n=2,B.findByIdAndUpdate(t.params.id,t.body,{new:!0}).populate("createdBy","name email").populate("visibleToSpecificAgents","name email");case 2:if(s=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Lead list not found"}));case 3:n.json(s),e.n=5;break;case 4:e.p=4,a=e.v,console.error("Lead list update error:",a),n.status(500).json({message:"Failed to update lead list"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.delete("/api/lead-lists/:id",U,function(){var e=g(p().m((function e(t,n){var s;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:return e.n=2,B.findById(t.params.id);case 2:if(e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Lead list not found"}));case 3:if("true"!==t.query.hard){e.n=6;break}return e.n=4,A.deleteMany({leadList:t.params.id});case 4:return e.n=5,B.findByIdAndDelete(t.params.id);case 5:n.json({message:"Lead list and associated leads deleted permanently"}),e.n=8;break;case 6:return e.n=7,B.findByIdAndUpdate(t.params.id,{isActive:!1},{new:!0});case 7:e.v,n.json({message:"Lead list deleted successfully"});case 8:e.n=10;break;case 9:e.p=9,s=e.v,console.error("Lead list deletion error:",s),n.status(500).json({message:"Failed to delete lead list"});case 10:return e.a(2)}}),e,null,[[0,9]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/lead-lists/:id/bulk-leads",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,u,l,d,m,f,g,y;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Admin access required"}));case 1:if(s=t.body.leads,a=t.params.id,s&&Array.isArray(s)){e.n=2;break}return e.a(2,n.status(400).json({message:"Leads array is required"}));case 2:return e.n=3,B.findById(a);case 3:if(e.v){e.n=4;break}return e.a(2,n.status(404).json({message:"Lead list not found"}));case 4:r=s.map((function(e){return i(i({},e),{},{leadList:a,status:e.status||"new"})})),o=100,u=0,l=[],d=0;case 5:if(!(d<r.length)){e.n=10;break}return m=r.slice(d,d+o),console.log("Processing batch ".concat(Math.floor(d/o)+1,"/").concat(Math.ceil(r.length/o)," (").concat(m.length," leads)")),e.p=6,e.n=7,A.insertMany(m);case 7:f=e.v,l.push.apply(l,c(f)),u+=f.length,e.n=9;break;case 8:e.p=8,g=e.v,console.error("Error in batch ".concat(Math.floor(d/o)+1,":"),g);case 9:d+=o,e.n=5;break;case 10:console.log("Bulk insert completed: ".concat(u,"/").concat(r.length," leads inserted successfully")),n.json({message:"Leads added successfully: ".concat(u,"/").concat(r.length," inserted"),inserted:u,total:r.length,leads:l.slice(0,10)}),e.n=12;break;case 11:e.p=11,y=e.v,console.error("Bulk leads creation error:",y),n.status(500).json({message:"Failed to add leads"});case 12:return e.a(2)}}),e,null,[[6,8],[0,11]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/customers",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s="agent"===t.user.role?{agent:t.user.id}:{},t.query.agent&&(s.agent=t.query.agent),t.query.status&&(s.status=t.query.status),t.query.search&&(a=new RegExp(t.query.search,"i"),s.$or=[{fullName:a},{email:a},{phone:a}]),e.n=1,O.find(s).populate("notes.createdBy","name").sort({createdAt:-1});case 1:r=e.v,o=r.map((function(e){var t=e.toObject();return t.customFields&&(t.customFields=Object.fromEntries(t.customFields)),t})),n.json(o),e.n=3;break;case 2:e.p=2,i=e.v,console.error("Customers fetch error:",i),n.status(500).json({message:"Failed to fetch customers"});case 3:return e.a(2)}}),e,null,[[0,2]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/customers/:id/notes",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s=t.body,a=s.status,r=s.note,e.n=1,O.findById(t.params.id);case 1:if(o=e.v){e.n=2;break}return e.a(2,n.status(404).json({message:"Customer not found"}));case 2:if("agent"!==t.user.role||o.agent.toString()===t.user.id){e.n=3;break}return e.a(2,n.status(403).json({message:"You can only update your own customers"}));case 3:return a&&(o.status=a),r&&r.content&&(o.notes||(o.notes=[]),o.notes.push({content:r.content,createdAt:new Date,createdBy:r.createdBy||t.user.id})),e.n=4,o.save();case 4:return e.n=5,o.populate("notes.createdBy","name");case 5:(i=o.toObject()).customFields&&(i.customFields=Object.fromEntries(i.customFields)),n.status(200).json(i),e.n=7;break;case 6:e.p=6,u=e.v,console.error("Error adding note to customer:",u),n.status(500).json({message:"Failed to add note to customer"});case 7:return e.a(2)}}),e,null,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/customers/:id/release",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,l,d,m,f;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role||"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can release customers"}));case 1:return s=t.params.id,e.n=2,O.findById(s);case 2:if(a=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Customer not found"}));case 3:if("agent"!==t.user.role||a.agent.toString()===t.user.id){e.n=4;break}return e.a(2,n.status(403).json({message:"You can only release your own customers"}));case 4:if(r=null,!a.originalLead){e.n=6;break}return e.n=5,A.findById(a.originalLead);case 5:r=e.v;case 6:if(o=null,i="General Pool",!a.originalLeadList){e.n=8;break}return e.n=7,B.findById(a.originalLeadList);case 7:(u=e.v)&&u.isActive&&(o=u,i=u.name);case 8:if(o){e.n=11;break}return e.n=9,q();case 9:if(l=e.v){e.n=10;break}return e.a(2,n.status(500).json({message:"Failed to create Users with no list"}));case 10:o=l,i=l.name;case 11:if(!r){e.n=13;break}return r.assignedTo=null,r.status=a.status||"new",r.notes||(r.notes=[]),r.notes=[].concat(c((a.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}}))),[{content:'Customer released back to leads pool. Returned to "'.concat(i,'" list.'),createdAt:new Date,createdBy:t.user.id}]),r.leadList=o._id,e.n=12,r.save();case 12:d=r,e.n=14;break;case 13:return d=new A({status:a.status||"new",assignedTo:null,customFields:a.customFields||new Map,leadList:o._id,notes:[{content:'Lead recreated from customer release. Added to "'.concat(i,'" list.'),createdAt:new Date,createdBy:t.user.id}].concat(c(a.notes?a.notes.filter((function(e){return new Date(e.createdAt)>=a.createdAt})).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}})):[]))}),e.n=14,d.save();case 14:return e.n=15,O.findByIdAndDelete(s);case 15:(m=d.toObject()).customFields&&(m.customFields=Object.fromEntries(m.customFields)),n.status(200).json({lead:m,targetList:i,message:'Customer successfully released back to leads pool in "'.concat(i,'" list')}),e.n=17;break;case 16:e.p=16,f=e.v,console.error("Error releasing customer:",f),n.status(500).json({message:"Failed to release customer"});case 17:return e.a(2)}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/customers/:id/move-to-depositors",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role||"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can move customers to depositors"}));case 1:return s=t.params.id,e.n=2,O.findById(s);case 2:if(a=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Customer not found"}));case 3:if("agent"!==t.user.role||a.agent.toString()===t.user.id){e.n=4;break}return e.a(2,n.status(403).json({message:"You can only move your own customers to depositors"}));case 4:return r=new D({fullName:a.fullName,email:a.email,phone:a.phone,country:a.country,language:a.language,status:a.status,customFields:a.customFields||new Map,agent:a.agent,originalCustomer:a._id,originalLead:a.originalLead,originalLeadList:a.originalLeadList,originalListName:a.originalListName,originalListLabels:a.originalListLabels,notes:[].concat(c((a.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}}))),[{content:"Customer moved to depositors list - deposit confirmed.",createdAt:new Date,createdBy:t.user.id}])}),e.n=5,r.save();case 5:return e.n=6,O.findByIdAndDelete(s);case 6:(o=r.toObject()).customFields&&(o.customFields=Object.fromEntries(o.customFields)),n.status(200).json({depositor:o,message:"Customer successfully moved to depositors list"}),e.n=8;break;case 7:e.p=7,i=e.v,console.error("Error moving customer to depositors:",i),n.status(500).json({message:"Failed to move customer to depositors"});case 8:return e.a(2)}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/depositors",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l,d,m,f,g,y;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s=t.query,a=s.page,r=void 0===a?1:a,o=s.limit,i=void 0===o?20:o,u=s.status,c=s.agentId,l=s.search,d={},"agent"===t.user.role?d.agent=t.user.id:c&&"admin"===t.user.role&&(d.agent=c),u&&(d.status=u),l&&(d.$or=[{fullName:{$regex:l,$options:"i"}},{email:{$regex:l,$options:"i"}},{phone:{$regex:l,$options:"i"}},{company:{$regex:l,$options:"i"}}]),e.n=1,D.find(d).populate("agent","name email").populate("notes.createdBy","name").sort({createdAt:-1}).limit(1*i).skip((r-1)*i);case 1:return m=e.v,e.n=2,D.countDocuments(d);case 2:f=e.v,g=m.map((function(e){var t=e.toObject();return t.customFields&&(t.customFields=Object.fromEntries(t.customFields)),t})),n.status(200).json({depositors:g,pagination:{current:parseInt(r),pages:Math.ceil(f/i),total:f}}),e.n=4;break;case 3:e.p=3,y=e.v,console.error("Error fetching depositors:",y),n.status(500).json({message:"Failed to fetch depositors"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/depositors/:id",U,function(){var e=g(p().m((function e(t,n){var s,a,r;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,D.findById(t.params.id).populate("agent","name email").populate("notes.createdBy","name");case 1:if(s=e.v){e.n=2;break}return e.a(2,n.status(404).json({message:"Depositor not found"}));case 2:if("agent"!==t.user.role||s.agent._id.toString()===t.user.id){e.n=3;break}return e.a(2,n.status(403).json({message:"Access denied"}));case 3:(a=s.toObject()).customFields&&(a.customFields=Object.fromEntries(a.customFields)),n.status(200).json({depositor:a}),e.n=5;break;case 4:e.p=4,r=e.v,console.error("Error fetching depositor:",r),n.status(500).json({message:"Failed to fetch depositor"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/depositors/:id/notes",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s=t.body,a=s.status,r=s.note,e.n=1,D.findById(t.params.id);case 1:if(o=e.v){e.n=2;break}return e.a(2,n.status(404).json({message:"Depositor not found"}));case 2:if("agent"!==t.user.role||o.agent.toString()===t.user.id){e.n=3;break}return e.a(2,n.status(403).json({message:"You can only add notes to your own depositors"}));case 3:return a&&(o.status=a),r&&r.content&&(o.notes||(o.notes=[]),o.notes.push({content:r.content,createdAt:new Date,createdBy:r.createdBy||t.user._id})),e.n=4,o.save();case 4:return e.n=5,o.populate("agent","name email");case 5:return e.n=6,o.populate("notes.createdBy","name");case 6:(i=o.toObject()).customFields&&(i.customFields=Object.fromEntries(i.customFields)),n.status(200).json(i),e.n=8;break;case 7:e.p=7,u=e.v,console.error("Error adding note to depositor:",u),n.status(500).json({message:"Failed to add note"});case 8:return e.a(2)}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}()),T.patch("/api/depositors/:id/status",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s=t.body.status){e.n=1;break}return e.a(2,n.status(400).json({message:"Status is required"}));case 1:if(["new","No Answer","Voice Mail","Call Back Qualified","Call Back NOT Qualified","deposited","active","withdrawn","inactive"].includes(s)){e.n=2;break}return e.a(2,n.status(400).json({message:"Invalid status"}));case 2:return e.n=3,D.findById(t.params.id);case 3:if(a=e.v){e.n=4;break}return e.a(2,n.status(404).json({message:"Depositor not found"}));case 4:if("agent"!==t.user.role||a.agent.toString()===t.user.id){e.n=5;break}return e.a(2,n.status(403).json({message:"You can only update your own depositors"}));case 5:return r=a.status,a.status=s,a.notes||(a.notes=[]),a.notes.push({content:'Status changed from "'.concat(r,'" to "').concat(s,'" by ').concat(t.user.name),createdAt:new Date,createdBy:t.user.id}),e.n=6,a.save();case 6:return e.n=7,a.populate("agent","name email");case 7:(o=a.toObject()).customFields&&(o.customFields=Object.fromEntries(o.customFields)),n.status(200).json({depositor:o,message:"Status updated successfully"}),e.n=9;break;case 8:e.p=8,i=e.v,console.error("Error updating depositor status:",i),n.status(500).json({message:"Failed to update status"});case 9:return e.a(2)}}),e,null,[[0,8]])})));return function(t,n){return e.apply(this,arguments)}}()),T.delete("/api/depositors/:id",U,function(){var e=g(p().m((function e(t,n){var s;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only admins can delete depositors"}));case 1:return e.n=2,D.findById(t.params.id);case 2:if(e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Depositor not found"}));case 3:return e.n=4,D.findByIdAndDelete(t.params.id);case 4:n.status(200).json({message:"Depositor deleted successfully"}),e.n=6;break;case 5:e.p=5,s=e.v,console.error("Error deleting depositor:",s),n.status(500).json({message:"Failed to delete depositor"});case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/depositors/:id/release-to-customers",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can release depositors"}));case 1:return e.n=2,D.findById(t.params.id);case 2:if(s=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Depositor not found"}));case 3:if(s.agent.toString()===t.user.id){e.n=4;break}return e.a(2,n.status(403).json({message:"You can only release your own depositors"}));case 4:return a=new O({fullName:s.fullName,email:s.email,phone:s.phone,country:s.country,language:s.language,company:s.company,status:s.status,customFields:s.customFields,agent:s.agent,originalLead:s.originalLead,originalLeadList:s.originalLeadList,originalListName:s.originalListName,originalListLabels:s.originalListLabels,notes:[].concat(c((s.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}}))),[{content:"Released from depositors list back to customers by ".concat(t.user.name),createdAt:new Date,createdBy:t.user.id}])}),e.n=5,a.save();case 5:return e.n=6,D.findByIdAndDelete(t.params.id);case 6:(r=a.toObject()).customFields&&(r.customFields=Object.fromEntries(r.customFields)),n.status(200).json({customer:r,message:"Depositor successfully released back to customers list"}),e.n=8;break;case 7:e.p=7,o=e.v,console.error("Error releasing depositor:",o),n.status(500).json({message:"Failed to release depositor"});case 8:return e.a(2)}}),e,null,[[0,7]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/depositors/:id/release",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,l,d,m;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"agent"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only agents can release depositors"}));case 1:return e.n=2,D.findById(t.params.id);case 2:if(s=e.v){e.n=3;break}return e.a(2,n.status(404).json({message:"Depositor not found"}));case 3:if(s.agent.toString()===t.user.id){e.n=4;break}return e.a(2,n.status(403).json({message:"You can only release your own depositors"}));case 4:if(a=null,!s.originalLead){e.n=6;break}return e.n=5,A.findById(s.originalLead);case 5:a=e.v;case 6:if(r=null,o="General Pool",!s.originalLeadList){e.n=8;break}return e.n=7,B.findById(s.originalLeadList);case 7:(i=e.v)&&i.isActive&&(r=i,o=i.name);case 8:if(r){e.n=11;break}return e.n=9,q();case 9:if(u=e.v){e.n=10;break}return e.a(2,n.status(500).json({message:"Failed to create Users with no list"}));case 10:r=u,o=u.name;case 11:if(!a){e.n=13;break}return a.assignedTo=null,a.status=s.status||"new",a.notes=[].concat(c((s.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}}))),[{content:'Depositor released back to leads pool. Returned to "'.concat(o,'" list.'),createdAt:new Date,createdBy:t.user.id}]),a.leadList=r._id,e.n=12,a.save();case 12:l=a,e.n=14;break;case 13:return l=new A({status:s.status||"new",assignedTo:null,customFields:s.customFields||new Map,leadList:r._id,notes:[{content:'Lead recreated from depositor release. Added to "'.concat(o,'" list.'),createdAt:new Date,createdBy:t.user.id}].concat(c((s.notes||[]).map((function(e){return{content:e.content,createdAt:e.createdAt,createdBy:e.createdBy}}))))}),e.n=14,l.save();case 14:return e.n=15,D.findByIdAndDelete(t.params.id);case 15:(d=l.toObject()).customFields&&(d.customFields=Object.fromEntries(d.customFields)),n.status(200).json({lead:d,targetList:o,message:'Depositor successfully released back to leads pool in "'.concat(o,'" list')}),e.n=17;break;case 16:e.p=16,m=e.v,console.error("Error releasing depositor to leads:",m),n.status(500).json({message:"Failed to release depositor to leads"});case 17:return e.a(2)}}),e,null,[[0,16]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/leads/:id/transfer",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,"admin"===t.user.role){e.n=1;break}return e.a(2,n.status(403).json({message:"Only admins can transfer leads between lists"}));case 1:if(s=t.params.id,a=t.body.targetListId){e.n=2;break}return e.a(2,n.status(400).json({message:"Target list ID is required"}));case 2:return e.n=3,A.findById(s);case 3:if(r=e.v){e.n=4;break}return e.a(2,n.status(404).json({message:"Lead not found"}));case 4:return e.n=5,B.findById(a);case 5:if(o=e.v){e.n=6;break}return e.a(2,n.status(404).json({message:"Target list not found"}));case 6:if(i="Unknown",!r.leadList){e.n=8;break}return e.n=7,B.findById(r.leadList);case 7:u=e.v,i=u?u.name:"Unknown";case 8:return r.leadList=a,r.notes||(r.notes=[]),r.notes.push({content:'Lead transferred from "'.concat(i,'" to "').concat(o.name,'" by admin ').concat(t.user.name),createdAt:new Date,createdBy:t.user.id}),e.n=9,r.save();case 9:(c=r.toObject()).customFields&&(c.customFields=Object.fromEntries(c.customFields)),n.status(200).json({lead:c,message:'Lead successfully transferred to "'.concat(o.name,'"')}),e.n=11;break;case 10:e.p=10,l=e.v,console.error("Error transferring lead:",l),n.status(500).json({message:"Failed to transfer lead"});case 11:return e.a(2)}}),e,null,[[0,10]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/leads/counts",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s={isActive:!0,isCustomerList:{$ne:!0}},"admin"!==t.user.role&&(s.$or=[{isVisibleToUsers:!0},{visibleToSpecificAgents:t.user.id}]),e.n=1,B.find(s).select("_id name");case 1:return a=e.v,r=a.map((function(e){return e._id})),console.log("[DEBUG] Found ".concat(a.length," lead lists:"),a.map((function(e){return{id:e._id,name:e.name}}))),e.n=2,A.find({}).limit(3).select("leadList");case 2:return o=e.v,console.log("[DEBUG] Sample leads with leadList field:",o),e.n=3,A.aggregate([{$match:{leadList:{$in:r}}},{$group:{_id:"$leadList",count:{$sum:1}}}]);case 3:i=e.v,console.log("[DEBUG] Aggregation result:",i),u={},i.forEach((function(e){u[e._id.toString()]=e.count})),console.log("[DEBUG] Count map:",u),c=a.map((function(e){return{listId:e._id,name:e.name,count:u[e._id.toString()]||0}})),console.log("[DEBUG] Final result being sent:",c),console.log("[LEADS COUNTS] User: ".concat(t.user.username," | Retrieved counts for ").concat(c.length," lists in single query")),n.json(c),e.n=5;break;case 4:e.p=4,l=e.v,console.error("Lead counts fetch error:",l),n.status(500).json({message:"Failed to fetch lead counts"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/",(function(e,t){t.redirect("/app")})),T.get("/login",(function(e,t){t.sendFile(k.join(__dirname,"public","login.html"))})),T.get("/app",(function(e,t){t.sendFile(k.join(__dirname,"public","index.html"))})),T.get("/clock",(function(e,t){t.sendFile(k.join(__dirname,"public","clock.html"))})),T.get("/api/clock/today",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,(s=new Date).setHours(0,0,0,0),(a=new Date(s)).setDate(a.getDate()+1),e.n=1,I.findOne({agent:t.user.id,date:{$gte:s,$lt:a}});case 1:r=e.v,n.json({entry:r}),e.n=3;break;case 2:e.p=2,o=e.v,console.error("Get today status error:",o),n.status(500).json({message:"Failed to get today status"});case 3:return e.a(2)}}),e,null,[[0,2]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/clock/in",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,(s=new Date).setHours(0,0,0,0),(a=new Date(s)).setDate(a.getDate()+1),e.n=1,I.findOne({agent:t.user.id,date:{$gte:s,$lt:a}});case 1:if(!(r=e.v)||"clocked-in"!==r.status){e.n=2;break}return e.a(2,n.status(400).json({message:"Already clocked in today"}));case 2:return o=new Date,e.n=3,F.findById(t.user.id);case 3:return i=e.v,u=i.hourlyRate||0,r?(r.clockIn=o,r.clockOut=null,r.status="clocked-in",r.hourlyRate=u,r.totalHours=0,r.totalPay=0):r=new I({agent:t.user.id,date:s,clockIn:o,status:"clocked-in",hourlyRate:u}),e.n=4,r.save();case 4:n.json({message:"Clocked in successfully",entry:r}),e.n=6;break;case 5:e.p=5,c=e.v,console.error("Clock in error:",c),n.status(500).json({message:"Failed to clock in"});case 6:return e.a(2)}}),e,null,[[0,5]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/clock/out",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,(s=new Date).setHours(0,0,0,0),(a=new Date(s)).setDate(a.getDate()+1),e.n=1,I.findOne({agent:t.user.id,date:{$gte:s,$lt:a},status:"clocked-in"});case 1:if(r=e.v){e.n=2;break}return e.a(2,n.status(400).json({message:"Not currently clocked in"}));case 2:return r.clockOut=new Date,r.status="clocked-out",e.n=3,r.save();case 3:n.json({message:"Clocked out successfully",entry:r}),e.n=5;break;case 4:e.p=4,o=e.v,console.error("Clock out error:",o),n.status(500).json({message:"Failed to clock out"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/clock/entries",U,function(){var e=g(p().m((function e(t,n){var s,a,r;return p().w((function(e){for(;;)switch(e.n){case 0:return e.p=0,s=parseInt(t.query.limit)||30,e.n=1,I.find({agent:t.user.id}).sort({date:-1}).limit(s).populate("agent","name");case 1:a=e.v,n.json({entries:a}),e.n=3;break;case 2:e.p=2,r=e.v,console.error("Get entries error:",r),n.status(500).json({message:"Failed to get entries"});case 3:return e.a(2)}}),e,null,[[0,2]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/clock/rate",U,_("admin"),function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s=t.body,a=s.agentId,r=s.hourlyRate,a&&void 0!==r){e.n=1;break}return e.a(2,n.status(400).json({message:"Agent ID and hourly rate are required"}));case 1:return e.n=2,F.findByIdAndUpdate(a,{hourlyRate:r});case 2:return(o=new Date).setHours(0,0,0,0),(i=new Date(o)).setDate(i.getDate()+1),e.n=3,I.updateOne({agent:a,date:{$gte:o,$lt:i}},{hourlyRate:r});case 3:n.json({message:"Hourly rate updated successfully"}),e.n=5;break;case 4:e.p=4,u=e.v,console.error("Update rate error:",u),n.status(500).json({message:"Failed to update hourly rate"});case 5:return e.a(2)}}),e,null,[[0,4]])})));return function(t,n){return e.apply(this,arguments)}}()),T.post("/api/clock/manual",U,_("admin"),function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l,d,m,f,g,y;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s=t.body,a=s.agentId,r=s.date,o=s.clockIn,i=s.clockOut,u=s.hourlyRate,c=s.notes,a&&r&&o&&i&&void 0!==u){e.n=1;break}return e.a(2,n.status(400).json({message:"All fields are required"}));case 1:return(l=new Date(r)).setHours(0,0,0,0),(d=new Date(l)).setDate(d.getDate()+1),e.n=2,I.findOne({agent:a,date:{$gte:l,$lt:d}});case 2:if(!e.v){e.n=3;break}return e.a(2,n.status(400).json({message:"Entry already exists for this date"}));case 3:if(m=new Date(r+"T"+o),!((f=new Date(r+"T"+i))<=m)){e.n=4;break}return e.a(2,n.status(400).json({message:"Clock out time must be after clock in time"}));case 4:return g=new I({agent:a,date:l,clockIn:m,clockOut:f,hourlyRate:u,status:"manual",isManualEntry:!0,notes:c||"",createdBy:t.user.id}),e.n=5,g.save();case 5:n.json({message:"Manual entry added successfully",entry:g}),e.n=7;break;case 6:e.p=6,y=e.v,console.error("Add manual entry error:",y),n.status(500).json({message:"Failed to add manual entry"});case 7:return e.a(2)}}),e,null,[[0,6]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("/api/clock/calendar",U,function(){var e=g(p().m((function e(t,n){var s,a,r,o,i,u,c,l,d;return p().w((function(e){for(;;)switch(e.n){case 0:if(e.p=0,s=t.query,a=s.year,r=s.month,o=s.agentId,a&&r){e.n=1;break}return e.a(2,n.status(400).json({message:"Year and month are required"}));case 1:return i=new Date(parseInt(a),parseInt(r)-1,1),u=new Date(parseInt(a),parseInt(r),0,23,59,59,999),c={date:{$gte:i,$lte:u}},o?c.agent=o:"agent"===t.user.role&&(c.agent=t.user.id),e.n=2,I.find(c).populate("agent","name").sort({date:1});case 2:l=e.v,n.json({entries:l}),e.n=4;break;case 3:e.p=3,d=e.v,console.error("Get calendar data error:",d),n.status(500).json({message:"Failed to get calendar data"});case 4:return e.a(2)}}),e,null,[[0,3]])})));return function(t,n){return e.apply(this,arguments)}}()),T.get("*",(function(e,t){e.path.startsWith("/api/")?t.status(404).json({message:"API endpoint not found"}):t.redirect("/app")}));var $=process.env.PORT||5e3;v.connection.once("open",g(p().m((function e(){return p().w((function(e){for(;;)switch(e.n){case 0:return console.log("MongoDB connected successfully"),e.n=1,q();case 1:console.log("System initialization complete");case 2:return e.a(2)}}),e)})))),T.listen($,(function(){return console.log("Server running on port ".concat($))}))})();